# shellcheck shell=sh
# vim: set ft=sh:
# NOTE: This gets sourced for both BASH and ZSH so be careful
# NOTE: This gets sourced by xsession as sh so needs to work with that!

# Make sure HOSTNAME is set
if [ "$HOSTNAME" = "" ]
then
	HOSTNAME=$(hostname -s)
fi
export HOSTNAME

# _DOT controls whether we've run this already or not
if [ "$_DOT" = "" ]
then
	echo "$HOSTNAME $(date +"%Y-%m-%d %H:%M:%S") $$ $PPID common/dot" >> "$HOME/.dot_log"
	_DOT=1

	# Add home bin to path. Useful for ssh
	PATH=$PATH:$HOME/bin

	# Ensure useful umask
	umask 022
fi

# Tweak $HOME to pick up locally mounted rather than NFS mounted
# if possible.
if [ "$_ORIG_HOME" = "" ] || [ "$_ORIG_HOME"  = "$HOME" ]
then
	if test -d "/home/local/$LOGNAME"
	then
		if test -e "/home/local/$LOGNAME/.dot"
		then
			export _ORIG_HOME=$HOME
			export HOME=/home/local/$LOGNAME
		fi
	fi
fi

# Find out true location. Note that this assumes we have actually
# been installed as ~/.profile!
if [ "$DOTFILES" = "" ]
then
	if ! DOTFILES=$(readlink ~/.dot)
	then
		DOTFILES=$(dirname "$DOTFILES")
		DOTFILES=${DOTFILES%/common}
		# Check for a relative path which won't start with a slash
		if [ "${DOTFILES##/*}" != "" ]
		then
			DOTFILES=~/$DOTFILES
		fi
	else
		DOTFILES=~/.dotfiles
	fi
fi

export DOTFILES
