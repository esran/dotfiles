# shellcheck shell=bash
# vim: set ft=sh:
# NOTE: This gets sourced for both BASH and ZSH so be careful

# Make sure HOSTNAME is set
[[ ! -z $HOSTNAME ]] || HOSTNAME=$(hostname -s)
export HOSTNAME

if [[ -z $_DOT ]]
then
	echo "$HOSTNAME $(date +"%Y-%m-%d %H:%M:%S") $$ $PPID common/dot" >> "$HOME/.dot_log"
	_DOT=1

	# Add home bin to path. Useful for ssh
	PATH=$PATH:$HOME/bin

	# Ensure useful umask
	umask 022
fi

# Tweak $HOME to pick up locally mounted rather than NFS mounted
# if possible.
if [[ -z $_ORIG_HOME ]]
then
	if [[ -d /home/local/$LOGNAME ]]
	then
		if [[ -e /home/local/$LOGNAME/.dot ]]
		then
			export _ORIG_HOME=$HOME
			export HOME=/home/local/$LOGNAME
		fi
	fi
fi

# Find out true location. Note that this assumes we have actually
# been installed as ~/.profile!
if [[ -z $DOTFILES ]]
then
	DOTFILES=$(readlink ~/.dot)
	if [[ $? -eq 0 ]]
	then
		DOTFILES=$(dirname "$DOTFILES")
		DOTFILES=${DOTFILES%/common}
		# Check for a relative path which won't start with a slash
		if [[ -n ${DOTFILES##/*} ]]
		then
			DOTFILES=~/$DOTFILES
		fi
	else
		DOTFILES=~/.dotfiles
	fi
fi

export DOTFILES
